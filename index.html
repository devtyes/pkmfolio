<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pok√©mon Portfolio</title>
    <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='8' fill='%23d4af37'/%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <link rel="stylesheet" href="/styles.css">
    <!-- Styles have been moved to styles.css to avoid rendering raw CSS text in the page -->
    <style>
        @media (min-width: 769px) {
            .mobile-nav { display: none !important; }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="logo">
            <div class="logo-icon"></div>
            <div class="logo-text">Pok√©mon <span class="gold">Portfolio</span></div>
        </div>
        <div class="auth-controls">
            <div id="saveWarning" class="save-warning">‚ö†Ô∏è Cr√©ez un compte pour conserver vos donn√©es</div>
            <button class="btn" id="helpBtn">Comment utiliser</button>
            <div id="userInfo" style="display: none; align-items: center; gap: 10px;">
                <span id="userEmailDisplay"></span>
                <button class="btn" id="logoutBtn">D√©connexion</button>
            </div>
            <button class="btn btn-primary" id="loginBtn">Connexion / Inscription</button>
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <div id="tab-portfolio" class="mobile-view active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Investi</div>
                        <div class="stat-value" id="totalInvested">0,00 ‚Ç¨</div>
                        <div class="stat-subtext" id="cardCount">0 carte (0 ligne)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Valeur Actuelle</div>
                        <div class="stat-value" id="currentValue">0,00 ‚Ç¨</div>
                        <div class="stat-subtext">Prix manuel</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">PNL Non R√©alis√©</div>
                        <div class="stat-value profit" id="unrealizedPnL">+0,00 ‚Ç¨</div>
                        <div class="stat-subtext profit" id="unrealizedPnLPercent">+0.0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">PNL R√©alis√©</div>
                        <div class="stat-value" id="realizedPnL">+0,00 ‚Ç¨</div>
                        <div class="stat-subtext" id="soldCount">0 vendue</div>
                    </div>
                </div>

                <div class="global-stats">
                    <div class="global-stats-title">üìä Statistiques Globales</div>
                    <div class="global-stats-grid">
                        <div class="global-stat-item expense-item">
                            <div class="stat-icon-wrapper">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor"><path d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V192c0-35.3-28.7-64-64-64H80c-8.8 0-16-7.2-16-16s7.2-16 16-16H448c17.7 0 32-14.3 32-32s-14.3-32-32-32H64zM416 272a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg>
                            </div>
                            <div class="stat-details">
                                <div class="global-stat-label">D√©penses Totales</div>
                                <div class="global-stat-value" id="totalExpenses">0,00 ‚Ç¨</div>
                            </div>
                        </div>
                        <div class="global-stat-item sales-item">
                            <div class="stat-icon-wrapper">
                                <img src="https://cdn-icons-png.flaticon.com/512/1389/1389079.png" alt="Ventes" style="width: 24px; height: 24px;">
                            </div>
                            <div class="stat-details">
                                <div class="global-stat-label">Ventes Totales</div>
                                <div class="global-stat-value profit" id="totalSales">0,00 ‚Ç¨</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <button class="btn active" data-filter="all" data-action="filterStatus"
                            data-value="all">Toutes</button>
                        <button class="btn" data-filter="unsold" data-action="filterStatus" data-value="unsold">Non
                            vendues</button>
                        <button class="btn" data-filter="sold" data-action="filterStatus"
                            data-value="sold">Vendues</button>
                        <div class="divider"></div>
                        <button class="btn" data-action="filterCondition" data-value="NM">NM</button>
                        <button class="btn" data-action="filterCondition" data-value="EX">EX</button>
                        <button class="btn" data-action="filterCondition" data-value="LP">LP</button>
                        <button class="btn" data-action="filterCondition" data-value="GOOD">GOOD</button>
                    </div>
                    <button class="btn btn-primary" id="addCardBtn" data-action="openModal">+ Ajouter une carte</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Carte</th>
                                <th>√âtat</th>
                                <th>Langue</th>
                                <th>Prix Achat</th>
                                <th>Prix Actuel</th>
                                <th>Vendue</th>
                                <th>Prix Vente</th>
                                <th>P&L Non R√©al.</th>
                                <th>P&L R√©al.</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="cardsTableBody">
                            <tr>
                                <td colspan="10">
                                    <div class="empty-state">
                                        <div class="empty-icon">üé¥</div>
                                        <h3 style="color: #d4af37; margin-bottom: 0.5rem;">Aucune carte dans ton
                                            portfolio</h3>
                                        <p>Clique sur "Ajouter une carte" pour commencer</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-analysis" class="mobile-view">
                <div class="portfolio-summary">
                    <div class="portfolio-summary-title">Analyse du Portfolio</div>
                    <div class="portfolio-summary-text">Statistiques et performance en temps r√©el</div>
                </div>

                <div class="card">
                    <div class="card-title">√âvolution du Portfolio</div>
                    <div class="chart-container">
                        <canvas id="portfolioChart"></canvas>
                    </div>
                </div>

                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-title">Performance des Cartes</div>
                    <div id="performersContainer"></div>
                </div>

                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-title">Analyse Mensuelle</div>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="cardModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Ajouter une carte</h2>
                <button class="close-btn" data-action="closeModal" type="button">√ó</button>
            </div>
            <div class="modal-body">
                <form id="cardForm" novalidate>
                    <input type="hidden" id="cardId" name="cardId">
                    <input type="hidden" id="isCloning" name="isCloning">
                    <div class="form-group">
                        <label for="cardName">Nom de la carte *</label>
                        <input type="text" id="cardName" name="cardName" required placeholder="Ex: Dracaufeu V Alt Art">
                    </div>
                    <div class="form-group">
                        <label for="cardImage">URL de l'image *</label>
                        <input type="url" id="cardImage" name="cardImage" required placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label for="cardmarketUrl">Lien Cardmarket *</label>
                        <input type="url" id="cardmarketUrl" name="cardmarketUrl" required
                            placeholder="https://www.cardmarket.com/...">
                    </div>
                    <div class="form-group" id="quantityGroup">
                        <label for="cardQuantity">Nombre d'exemplaires</label>
                        <input type="number" id="cardQuantity" name="cardQuantity" value="1" min="1" required>
                    </div>

                    <div id="bulkFields" style="display:none; max-height: 300px; overflow-y: auto; border: 1px solid #2d2d2d; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
                        <!-- Les champs dynamiques seront ins√©r√©s ici par JS -->
                    </div>

                    <div id="singleCardFields">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cardCondition">√âtat *</label>
                                <select id="cardCondition" name="cardCondition" required>
                                    <option value="NM">NM (Near Mint)</option>
                                    <option value="EX">EX (Excellent)</option>
                                    <option value="LP">LP (Light Played)</option>
                                    <option value="GOOD">GOOD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cardLanguage">Langue *</label>
                                <select id="cardLanguage" name="cardLanguage" required>
                                    <option value="FR">FR (Fran√ßais)</option>
                                    <option value="ENG">ENG (Anglais)</option>
                                    <option value="JP">JP (Japonais)</option>
                                    <option value="DE">DE (Allemand)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="purchasePrice">Prix d'achat (‚Ç¨) *</label>
                                <input type="number" id="purchasePrice" name="purchasePrice" step="0.01" required
                                    placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label for="currentPrice">Prix actuel (‚Ç¨)</label>
                                <input type="number" id="currentPrice" name="currentPrice" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="isSold" name="isSold">
                                <label for="isSold" style="margin: 0;">Cette carte a √©t√© vendue</label>
                            </div>
                        </div>
                        <div class="form-group" id="salePriceGroup" style="display: none;">
                            <label for="salePrice">Prix de vente (‚Ç¨) *</label>
                            <input type="number" id="salePrice" name="salePrice" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" type="button" data-action="closeModal">Annuler</button>
                <button class="btn btn-primary" type="submit" form="cardForm" id="submitBtn">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal d'Aide -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Comment utiliser</h2>
                <button class="close-btn" id="closeHelpModal" type="button">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color: #d4af37; font-weight: bold; margin-bottom: 1rem;">Bienvenue sur votre Portfolio Pok√©mon !</p>
                <p style="margin-bottom: 1rem;">Voici quelques conseils pour bien d√©marrer :</p>
                <ul style="padding-left: 1.5rem; line-height: 1.6; color: #b8b8b8;">
                    <li style="margin-bottom: 0.5rem;"><strong>Fonctionnement manuel :</strong> Il n'y a pas d'API, donc toutes les informations doivent √™tre modifi√©es √† la main.</li>
                    <li style="margin-bottom: 0.5rem;"><strong>Ajouter une carte :</strong> Cliquez sur le bouton "+ Ajouter une carte" pour enregistrer vos achats. Vous pouvez ajouter plusieurs exemplaires d'un coup.</li>
                    <li style="margin-bottom: 0.5rem;"><strong>Suivre la valeur :</strong> Mettez √† jour r√©guli√®rement le "Prix Actuel" de vos cartes via l'ic√¥ne üîÑ ou ‚úé pour voir l'√©volution de votre investissement.</li>
                    <li style="margin-bottom: 0.5rem;"><strong>Vendre :</strong> Lorsqu'une carte est vendue, passez son statut √† "Oui" dans la colonne Vendue pour calculer votre b√©n√©fice r√©el.</li>
                    <li><strong>Analyser :</strong> Consultez l'onglet "Analyse" (sur mobile) ou la colonne de droite (sur PC) pour voir vos graphiques de performance.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Modal d'Authentification -->
    <div class="modal" id="authModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">Authentification</h2>
                <button class="close-btn" id="closeAuthModal" type="button">√ó</button>
            </div>
            <div class="modal-body">
                <form id="authForm">
                    <div id="authError"></div>
                    <div class="form-group">
                        <label for="authEmail">Email</label>
                        <input type="email" id="authEmail" required placeholder="email@exemple.com">
                    </div>
                    <div class="form-group">
                        <label for="authPassword">Mot de passe</label>
                        <input type="password" id="authPassword" required placeholder="******" minlength="6">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 1rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;" id="submitLoginBtn">Se
                            connecter</button>
                        <button type="button" class="btn" style="flex: 1;" id="submitRegisterBtn">S'inscrire</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation Bar -->
    <nav class="mobile-nav">
        <button class="nav-item active" data-target="tab-portfolio">
            <span class="nav-icon">üé¥</span>
            <span class="nav-label">Portfolio</span>
        </button>
        <button class="nav-item" data-target="tab-analysis">
            <span class="nav-icon">üìà</span>
            <span class="nav-label">Analyse</span>
        </button>
    </nav>

    <script type="module">
        // Importation des modules Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIGURATION FIREBASE - REMPLACE CECI PAR TA PROPRE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyDDo3ckUexTbZJjWybvLLD_ALXY9Blkj0I",
            authDomain: "pkmfolio.firebaseapp.com",
            projectId: "pkmfolio",
            storageBucket: "pkmfolio.firebasestorage.app",
            messagingSenderId: "498818844894",
            appId: "1:498818844894:web:4b8cdda4b806cada0b9a4f",
            measurementId: "G-KJDKZN1HPK"
        };

        // Initialisation Firebase
        let app, auth, db;
        let currentUser = null;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Erreur init Firebase. As-tu rempli la config ?", e);
        }

        let cards = [];
        let filters = { status: 'all', condition: 'all' };
        let charts = {};
        let expandedGroups = new Set();

        document.addEventListener('DOMContentLoaded', () => {
            // Initial load from local storage to show something immediately (or empty)
            // The real data load happens in onAuthStateChanged
            const localData = localStorage.getItem('pokemonCards');
            if (localData) {
                cards = JSON.parse(localData);
                sanitizeCardsArray(cards);
            }

            // Auth Listeners
            if (auth) {
                onAuthStateChanged(auth, async (user) => {
                    currentUser = user;
                    updateAuthUI();
                    if (user) {
                        // Load from Firestore
                        await loadDataFromCloud();
                    } else {
                        // Fallback to local storage or clear
                        // For now, we keep local view if logged out, or reload local
                        const local = localStorage.getItem('pokemonCards');
                        cards = local ? JSON.parse(local) : [];
                        sanitizeCardsArray(cards);
                        refreshUI();
                    }
                });
            }

            // Auth UI Bindings
            document.getElementById('loginBtn').addEventListener('click', () => document.getElementById('authModal').classList.add('active'));
            document.getElementById('closeAuthModal').addEventListener('click', () => document.getElementById('authModal').classList.remove('active'));
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('submitLoginBtn').addEventListener('click', (e) => handleAuth(e, 'login'));
            document.getElementById('submitRegisterBtn').addEventListener('click', (e) => handleAuth(e, 'register'));

            // Help Modal Bindings
            document.getElementById('helpBtn').addEventListener('click', () => document.getElementById('helpModal').classList.add('active'));
            document.getElementById('closeHelpModal').addEventListener('click', () => document.getElementById('helpModal').classList.remove('active'));
            document.getElementById('helpModal').addEventListener('click', (e) => { if (e.target.id === 'helpModal') document.getElementById('helpModal').classList.remove('active'); });

            // App Init
            initCharts();
            renderCards();
            updateStats();
            renderPerformers();
            attachEventHandlers(); // wire dynamic event listeners

            // bind static controls
            document.getElementById('addCardBtn')?.addEventListener('click', openModal);
            document.getElementById('isSold')?.addEventListener('change', toggleSoldFields);
            document.getElementById('cardForm')?.addEventListener('submit', saveCard);
            document.querySelectorAll('[data-action="filterStatus"]').forEach(btn => {
                btn.addEventListener('click', (e) => filterByStatus(e.currentTarget.dataset.value, e.currentTarget));
            });
            document.querySelectorAll('[data-action="filterCondition"]').forEach(btn => {
                btn.addEventListener('click', (e) => filterByCondition(e.currentTarget.dataset.value, e.currentTarget));
            });

            // Gestionnaire pour le changement de quantit√© (Mode Bulk)
            document.getElementById('cardQuantity')?.addEventListener('input', (e) => {
                const qty = parseInt(e.target.value) || 1;
                const singleFields = document.getElementById('singleCardFields');
                const bulkFields = document.getElementById('bulkFields');
                
                if (qty > 1) {
                    // Mode multiple : on cache les champs uniques et on g√©n√®re la liste
                    singleFields.style.display = 'none';
                    // D√©sactiver les champs uniques pour √©viter les erreurs de validation HTML "An invalid form control is not focusable"
                    singleFields.querySelectorAll('input, select').forEach(el => el.disabled = true);
                    
                    bulkFields.style.display = 'block';
                    
                    // R√©cup√©rer les valeurs par d√©faut
                    const defCond = document.getElementById('cardCondition').value;
                    const defLang = document.getElementById('cardLanguage').value;
                    const defPurch = document.getElementById('purchasePrice').value;
                    const defCurr = document.getElementById('currentPrice').value;
                    
                    let html = '';
                    for(let i=0; i<qty; i++) {
                        html += `
                        <div class="bulk-row" style="border-bottom: 1px solid #2d2d2d; padding-bottom: 10px; margin-bottom: 10px;">
                            <div style="font-weight: bold; margin-bottom: 5px; color: #d4af37;">Exemplaire #${i+1}</div>
                            <div class="form-row">
                                <div class="form-group" style="margin-bottom: 5px;">
                                    <label style="font-size: 0.8rem;">√âtat</label>
                                    <select class="bulk-condition" style="padding: 8px; background: #2d2d2d; border: 1px solid #3d3d3d; color: #e0e0e0; border-radius: 4px; width: 100%;">
                                        <option value="NM" ${defCond==='NM'?'selected':''}>NM</option>
                                        <option value="EX" ${defCond==='EX'?'selected':''}>EX</option>
                                        <option value="LP" ${defCond==='LP'?'selected':''}>LP</option>
                                        <option value="GOOD" ${defCond==='GOOD'?'selected':''}>GOOD</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 5px;">
                                    <label style="font-size: 0.8rem;">Langue</label>
                                    <select class="bulk-language" style="padding: 8px; background: #2d2d2d; border: 1px solid #3d3d3d; color: #e0e0e0; border-radius: 4px; width: 100%;">
                                        <option value="FR" ${defLang==='FR'?'selected':''}>FR</option>
                                        <option value="ENG" ${defLang==='ENG'?'selected':''}>ENG</option>
                                        <option value="JP" ${defLang==='JP'?'selected':''}>JP</option>
                                        <option value="DE" ${defLang==='DE'?'selected':''}>DE</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 0.8rem;">Prix Achat (‚Ç¨)</label>
                                    <input type="number" class="bulk-purchase" step="0.01" value="${defPurch}" style="padding: 8px; background: #2d2d2d; border: 1px solid #3d3d3d; color: #e0e0e0; border-radius: 4px; width: 100%;">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="font-size: 0.8rem;">Prix Actuel (‚Ç¨)</label>
                                    <input type="number" class="bulk-current" step="0.01" value="${defCurr}" style="padding: 8px; background: #2d2d2d; border: 1px solid #3d3d3d; color: #e0e0e0; border-radius: 4px; width: 100%;">
                                </div>
                            </div>
                        </div>`;
                    }
                    bulkFields.innerHTML = html;
                } else {
                    // Mode simple
                    singleFields.style.display = 'block';
                    singleFields.querySelectorAll('input, select').forEach(el => el.disabled = false);
                    toggleSoldFields(); // R√©appliquer la logique de vente
                    
                    bulkFields.style.display = 'none';
                    bulkFields.innerHTML = '';
                }
            });

            // Mobile Tab Navigation
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.querySelectorAll('.mobile-view').forEach(v => {
                        v.classList.remove('active');
                        if (v.id === btn.dataset.target) v.classList.add('active');
                    });
                });
            });
        });

        // --- Auth Functions ---

        function updateAuthUI() {
            const loginBtn = document.getElementById('loginBtn');
            const userInfo = document.getElementById('userInfo');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const saveWarning = document.getElementById('saveWarning');

            if (currentUser) {
                loginBtn.style.display = 'none';
                userInfo.style.display = 'flex';
                userEmailDisplay.textContent = currentUser.email;
                if (saveWarning) saveWarning.style.display = 'none';
            } else {
                loginBtn.style.display = 'block';
                userInfo.style.display = 'none';
                userEmailDisplay.textContent = '';
                if (saveWarning) saveWarning.style.display = 'block';
            }
        }

        async function handleAuth(e, mode) {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const errorDiv = document.getElementById('authError');

            try {
                if (mode === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // Initialisation du document utilisateur dans Firestore
                    await setDoc(doc(db, "users", userCredential.user.uid), {
                        email: email,
                        createdAt: new Date().toISOString(),
                        cards: [] // On initialise avec un tableau vide
                    });
                    await sendEmailVerification(userCredential.user);
                    alert("Compte cr√©√© ! Un email de v√©rification a √©t√© envoy√© √† " + email + ". Veuillez v√©rifier votre bo√Æte de r√©ception.");
                }
                document.getElementById('authModal').classList.remove('active');
                document.getElementById('authForm').reset();
                errorDiv.style.display = 'none';
            } catch (error) {
                errorDiv.textContent = "Erreur: " + error.message;
                errorDiv.style.display = 'block';
            }
        }

        async function handleLogout() {
            await signOut(auth);
        }

        // --- Data Persistence Functions ---

        async function saveData() {
            if (currentUser && db) {
                // Save to Cloud
                try {
                    // On ajoute { merge: true } pour ne pas effacer l'email et la date de cr√©ation
                    await setDoc(doc(db, "users", currentUser.uid), { cards: cards }, { merge: true });
                } catch (e) {
                    console.error("Error saving to cloud", e);
                    alert("Erreur de sauvegarde : " + e.message + "\n\nV√©rifiez que la base de donn√©es Firestore est bien cr√©√©e et que les r√®gles de s√©curit√© autorisent l'√©criture.");
                    throw e;
                }
            } else {
                // Save to Local
                localStorage.setItem('pokemonCards', JSON.stringify(cards));
            }
        }

        async function loadDataFromCloud() {
            const docSnap = await getDoc(doc(db, "users", currentUser.uid));
            if (docSnap.exists()) {
                cards = docSnap.data().cards || [];
                sanitizeCardsArray(cards);
                refreshUI();
            } else {
                // First time login? Optional: Upload local data to cloud
                if (cards.length > 0 && confirm("Voulez-vous sauvegarder votre portfolio local sur le cloud ?")) {
                    await saveData();
                }
            }
        }

        function refreshUI() {
            renderCards();
            updateStats();
            updateCharts();
            renderPerformers();
        }

        function getCardKey(card) {
            return `${card.name}|||${card.condition}|||${card.language}`;
        }

        function groupCards(cardsList) {
            const groups = {};
            cardsList.forEach(card => {
                const key = getCardKey(card);
                if (!groups[key]) {
                    groups[key] = {
                        key, name: card.name, imageUrl: card.imageUrl, cardmarketUrl: card.cardmarketUrl,
                        condition: card.condition, language: card.language, cards: [], count: 0, totalInvested: 0,
                        currentValue: 0, currentPrice: card.currentPrice, unrealizedPnL: 0, realizedPnL: 0
                    };
                }
                const group = groups[key];
                group.cards.push(card);
                group.count++;
                group.totalInvested += card.purchasePrice;
                if (!card.isSold && card.currentPrice) {
                    group.currentValue += card.currentPrice;
                    group.unrealizedPnL += (card.currentPrice - card.purchasePrice);
                }
                if (card.isSold && card.salePrice) {
                    group.realizedPnL += (card.salePrice - card.purchasePrice);
                }
                if (card.currentPrice !== null && card.currentPrice !== undefined) {
                    group.currentPrice = card.currentPrice;
                }
            });
            return Object.values(groups);
        }

        function openModal(editCard = null, cloneFromCard = null) {
            document.getElementById('cardModal').classList.add('active');
            document.getElementById('cardForm').reset();
            document.getElementById('cardId').value = '';
            document.getElementById('isCloning').value = '';
            document.getElementById('salePriceGroup').style.display = 'none';

            // Reset Bulk UI
            document.getElementById('cardQuantity').value = 1;
            document.getElementById('quantityGroup').style.display = 'block';
            document.getElementById('cardQuantity').dispatchEvent(new Event('input')); // Trigger reset logic

            if (editCard) {
                document.getElementById('modalTitle').textContent = 'Modifier une carte';
                document.getElementById('submitBtn').textContent = 'Enregistrer';
                document.getElementById('cardId').value = editCard.id;
                document.getElementById('cardName').value = editCard.name;
                document.getElementById('cardImage').value = editCard.imageUrl;
                document.getElementById('cardmarketUrl').value = editCard.cardmarketUrl;
                document.getElementById('cardCondition').value = editCard.condition;
                document.getElementById('cardLanguage').value = editCard.language;
                document.getElementById('purchasePrice').value = editCard.purchasePrice;
                document.getElementById('currentPrice').value = editCard.currentPrice || '';
                document.getElementById('isSold').checked = editCard.isSold;
                if (editCard.isSold) {
                    document.getElementById('salePriceGroup').style.display = 'block';
                    document.getElementById('salePrice').value = editCard.salePrice || '';
                }
                ['cardName', 'cardImage', 'cardmarketUrl', 'cardLanguage'].forEach(id => {
                    document.getElementById(id).disabled = false;
                });
                document.getElementById('quantityGroup').style.display = 'none'; // Pas de quantit√© en √©dition
            } else if (cloneFromCard) {
                document.getElementById('modalTitle').textContent = 'Cloner une carte';
                document.getElementById('submitBtn').textContent = 'Cloner';
                document.getElementById('isCloning').value = 'true';
                document.getElementById('cardName').value = cloneFromCard.name;
                document.getElementById('cardImage').value = cloneFromCard.imageUrl;
                document.getElementById('cardmarketUrl').value = cloneFromCard.cardmarketUrl;
                document.getElementById('cardLanguage').value = cloneFromCard.language;
                ['cardName', 'cardImage', 'cardmarketUrl', 'cardLanguage'].forEach(id => {
                    document.getElementById(id).disabled = true;
                });
                if (cloneFromCard.currentPrice) {
                    document.getElementById('currentPrice').value = cloneFromCard.currentPrice;
                }
            } else {
                document.getElementById('modalTitle').textContent = 'Ajouter une carte';
                document.getElementById('submitBtn').textContent = 'Ajouter';
                ['cardName', 'cardImage', 'cardmarketUrl', 'cardLanguage'].forEach(id => {
                    document.getElementById(id).disabled = false;
                });
            }
        }

        function closeModal() {
            document.getElementById('cardModal').classList.remove('active');
        }

        function toggleSoldFields() {
            const isSold = document.getElementById('isSold').checked;
            document.getElementById('salePriceGroup').style.display = isSold ? 'block' : 'none';
            document.getElementById('salePrice').required = isSold;
        }

        async function saveCard(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sauvegarde...';

            const cardId = document.getElementById('cardId').value;
            const cardData = {
                name: document.getElementById('cardName').value,
                imageUrl: document.getElementById('cardImage').value,
                cardmarketUrl: document.getElementById('cardmarketUrl').value,
                condition: !document.getElementById('cardCondition').disabled ? document.getElementById('cardCondition').value : 'NM',
                language: !document.getElementById('cardLanguage').disabled ? document.getElementById('cardLanguage').value : 'FR',
                purchasePrice: !document.getElementById('purchasePrice').disabled ? parseFloat(document.getElementById('purchasePrice').value) : 0,
                currentPrice: !document.getElementById('currentPrice').disabled ? (parseFloat(document.getElementById('currentPrice').value) || null) : null,
                isSold: !document.getElementById('isSold').disabled ? document.getElementById('isSold').checked : false,
                salePrice: (!document.getElementById('isSold').disabled && document.getElementById('isSold').checked) ? parseFloat(document.getElementById('salePrice').value) : null,
            };

            if (cardId) {
                const targetKey = getCardKey(cardData);
                cards = cards.map(c => {
                    if (c.id === cardId) {
                        return { ...c, ...cardData, updatedAt: new Date().toISOString() };
                    }
                    // Mise √† jour du prix pour tous les exemplaires identiques
                    if (getCardKey(c) === targetKey) {
                        return { ...c, currentPrice: cardData.currentPrice };
                    }
                    return c;
                });
            } else {
                const quantity = parseInt(document.getElementById('cardQuantity').value) || 1;
                
                if (quantity > 1) {
                    // Cr√©ation multiple avec champs sp√©cifiques
                    const bulkRows = document.querySelectorAll('.bulk-row');
                    bulkRows.forEach((row, index) => {
                        const condition = row.querySelector('.bulk-condition').value;
                        const language = row.querySelector('.bulk-language').value;
                        const purchasePrice = parseFloat(row.querySelector('.bulk-purchase').value) || 0;
                        const currentPrice = parseFloat(row.querySelector('.bulk-current').value) || null;
                        
                        const card = {
                            name: cardData.name,
                            imageUrl: cardData.imageUrl,
                            cardmarketUrl: cardData.cardmarketUrl,
                            condition: condition,
                            language: language,
                            purchasePrice: purchasePrice,
                            currentPrice: currentPrice,
                            isSold: false, // En masse, on assume non vendu
                            salePrice: null,
                            id: Date.now().toString() + Math.random().toString(36).substr(2, 9) + index,
                            createdAt: new Date().toISOString()
                        };
                        cards.push(card);
                    });
                } else {
                    // Cr√©ation simple
                    const card = {
                        ...cardData,
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        createdAt: new Date().toISOString()
                    };
                    const similarCards = cards.filter(c => getCardKey(c) === getCardKey(card));
                    if (similarCards.length > 0 && similarCards[0].currentPrice !== null && !card.currentPrice) {
                        card.currentPrice = similarCards[0].currentPrice;
                    }
                    cards.push(card);
                }
            }

            try {
                await saveData(); // Use central save function
                closeModal();
                refreshUI();
            } catch (e) {
                // L'erreur est d√©j√† affich√©e par saveData
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        function editCard(cardId) {
            const card = cards.find(c => c.id === cardId);
            if (card) openModal(card);
        }

        function cloneCard(cardId) {
            const card = cards.find(c => c.id === cardId);
            if (card) openModal(null, card);
        }

        function deleteCard(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette carte ?')) {
                cards = cards.filter(c => c.id !== id);
                saveData();
                refreshUI();
            }
        }

        function toggleSoldStatus(cardId, value) {
            const card = cards.find(c => c.id === cardId);
            if (!card) return;
            card.isSold = value === 'yes';
            if (!card.isSold) {
                card.salePrice = null;
            }
            saveData();
            refreshUI();
        }

        function updateSalePrice(cardId, value) {
            const card = cards.find(c => c.id === cardId);
            if (!card) return;
            const price = parseFloat(value);
            if (!isNaN(price)) {
                card.salePrice = price;
                saveData();
                refreshUI();
            }
        }

        function updateCurrentPrice(groupKey) {
            const currentCard = cards.find(c => getCardKey(c) === groupKey);
            const oldPrice = currentCard ? currentCard.currentPrice : '';
            const newPriceStr = prompt("Entrez le nouveau prix actuel pour ce groupe de cartes :", oldPrice);

            if (newPriceStr === null) return; // User cancelled

            const newPrice = parseFloat(newPriceStr);

            if (!isNaN(newPrice) && newPrice >= 0) {
                cards.forEach(card => {
                    if (getCardKey(card) === groupKey) {
                        card.currentPrice = newPrice;
                    }
                });
                saveData();
                refreshUI();
            } else if (newPriceStr !== '') {
                alert("Veuillez entrer un nombre valide.");
            }
        }

        function toggleGroup(groupKey) {
            expandedGroups.has(groupKey) ? expandedGroups.delete(groupKey) : expandedGroups.add(groupKey);
            renderCards();
        }

        function filterByStatus(status, btn) {
            filters.status = status;
            filters.condition = 'all';
            document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.filter-group .btn:not([data-filter])').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderCards();
        }

        function filterByCondition(condition, btn) {
            if (filters.condition === condition) {
                filters.condition = 'all';
                btn.classList.remove('active');
            } else {
                document.querySelectorAll('.filter-group .btn:not([data-filter])').forEach(b => b.classList.remove('active'));
                filters.condition = condition;
                btn.classList.add('active');
            }
            renderCards();
        }

        function renderCards() {
            let filteredCards = cards;
            if (filters.status === 'sold') filteredCards = filteredCards.filter(c => c.isSold);
            else if (filters.status === 'unsold') filteredCards = filteredCards.filter(c => !c.isSold);
            if (filters.condition !== 'all') filteredCards = filteredCards.filter(c => c.condition === filters.condition);

            const tbody = document.getElementById('cardsTableBody');
            if (filteredCards.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10"><div class="empty-state"><div class="empty-icon">üé¥</div><h3 style="color: #d4af37; margin-bottom: 0.5rem;">Aucune carte trouv√©e</h3><p>Essaie de modifier les filtres ou ajoute des cartes</p></div></td></tr>`;
                return;
            }

            const groups = groupCards(filteredCards);
            let html = '';
            groups.forEach(group => {
                const isExpanded = expandedGroups.has(group.key);
                const unrealizedPnLPercent = group.totalInvested > 0 ? (group.unrealizedPnL / group.totalInvested) * 100 : 0;
                const escapedKey = group.key.replace(/'/g, "\\'");
                html += `<tr class="group-row"><td><div class="card-cell">${group.count > 1 ? `<button class="expand-btn ${isExpanded ? '' : 'collapsed'}" type="button" aria-label="Afficher/masquer le groupe" data-action="toggleGroup" data-key="${escapedKey}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 298"><path d="M256 298L0 0h512L256 298z"/></svg></button>` : '<div style="width: 18px;"></div>'}<div class="card-img-container"><img src="${group.imageUrl || ''}" alt="${group.name}" class="card-img""><div class="card-count-badge">${group.count}</div><button class="clone-btn" type="button" aria-label="Cloner la carte" data-action="cloneCard" data-id="${group.cards[0].id}" title="Cloner">+</button></div><div class="card-info"><a href="${group.cardmarketUrl}" target="_blank" class="card-name">${group.name}</a></div></div></td><td><span class="badge">${group.condition}</span></td><td><span class="badge">${group.language}</span></td><td class="text-right"><strong>${formatCurrency(group.totalInvested)}</strong></td><td class="text-right"><div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px;"><span>${group.currentPrice ? formatCurrency(group.currentPrice * group.count) : 'N/A'}</span>${group.currentPrice !== null && group.currentPrice !== undefined ? `<button class="icon-btn" data-action="updateCurrentPrice" data-key="${escapedKey}" title="Modifier le prix actuel du groupe"><img src="https://cdn-icons-png.flaticon.com/512/98/98688.png" style="width: 14px; height: 14px;" alt="Modifier le prix"></button>` : ''}</div></td><td class="text-center">${group.count === 1 ? `<select class="sold-select" name="soldSelect" aria-label="Vendue" data-role="sold-select" data-id="${group.cards[0].id}"><option value="no" ${!group.cards[0].isSold ? 'selected' : ''}>Non</option><option value="yes" ${group.cards[0].isSold ? 'selected' : ''}>Oui</option></select>` : '-'}</td><td class="text-right">${group.count === 1 ? (group.cards[0].isSold ? (group.cards[0].salePrice !== null && group.cards[0].salePrice !== undefined ? formatCurrency(group.cards[0].salePrice) : `<input type="number" class="sale-price-input" data-id="${group.cards[0].id}" step="0.01" placeholder="Prix" style="width: 80px; text-align: right; padding: 0.25rem; background: #252525; border: 1px solid #3d3d3d; color: #f5f5f5; border-radius: 4px;">`) : '-') : '-'}</td><td class="text-right"><div class="${group.unrealizedPnL >= 0 ? 'profit' : 'loss'}"><strong>${formatCurrency(group.unrealizedPnL)}</strong></div><div style="font-size: 0.875rem;" class="${unrealizedPnLPercent >= 0 ? 'profit' : 'loss'}">${unrealizedPnLPercent >= 0 ? '+' : ''}${unrealizedPnLPercent.toFixed(2)}%</div></td><td class="text-right ${group.realizedPnL >= 0 ? 'profit' : 'loss'}">${group.realizedPnL !== 0 ? formatCurrency(group.realizedPnL) : '-'}</td><td><div class="actions"><button class="icon-btn" type="button" aria-label="Modifier la carte" data-action="editCard" data-id="${group.cards[0].id}" title="Modifier"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M441 58.9L453.1 71c9.4 9.4 9.4 24.6 0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9 0zM209.8 256.2L344 122l46.1 46.1-134.3 134.2c-2.9 2.9-6.5 5-10.4 6.1L186.9 325l16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25L175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 100c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l100-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7 0-101.8L474.9 25c-28.1-28.1-73.7-28.1-101.8 0zM88 64C39.4 64 0 103.4 0 152V424c0 48.6 39.4 88 88 88H360c48.6 0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1 0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H200c13.3 0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg></button><button class="icon-btn danger" type="button" aria-label="Supprimer la carte" data-action="deleteCard" data-id="${group.cards[0].id}" title="Supprimer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M170.5 51.6L151.5 80h145l-19-28.4c-1.5-2.2-4-3.6-6.7-3.6H177.1c-2.7 0-5.2 1.3-6.7 3.6zm147-26.6L354.2 80H368h48 8c13.3 0 24 10.7 24 24s-10.7 24-24 24h-8V432c0 44.2-35.8 80-80 80H112c-44.2 0-80-35.8-80-80V128H24c-13.3 0-24-10.7-24-24S10.7 80 24 80h8H80h13.8l36.7-55.1C140.9 9.4 158.4 0 177.1 0h93.7c18.7 0 36.2 9.4 46.6 24.9zM80 128V432c0 17.7 14.3 32 32 32H336c17.7 0 32-14.3 32-32V128H80zm80 64V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16z"/></svg></button></div></td></tr>`;
                if (isExpanded && group.count > 1) {
                    group.cards.forEach(card => {
                        const cardUnrealizedPnL = card.isSold ? 0 : (card.currentPrice || 0) - card.purchasePrice;
                        const cardRealizedPnL = card.isSold && card.salePrice ? card.salePrice - card.purchasePrice : 0;
                        html += `<tr class="detail-row"><td style="padding-left: 3.5rem;"><span style="color: #808080; font-size: 0.875rem;">#${card.id.slice(-6)}</span></td><td><span style="color: #b8b8b8; font-size: 0.875rem;">${card.condition}</span></td><td><span style="color: #b8b8b8; font-size: 0.875rem;">${card.language}</span></td><td class="text-right">${formatCurrency(card.purchasePrice)}</td><td class="text-right">${card.currentPrice ? formatCurrency(card.currentPrice) : 'N/A'}</td><td class="text-center"><select class="sold-select" data-role="sold-select" data-id="${card.id}"><option value="no" ${!card.isSold ? 'selected' : ''}>Non</option><option value="yes" ${card.isSold ? 'selected' : ''}>Oui</option></select></td><td class="text-right">${card.isSold ? (card.salePrice !== null && card.salePrice !== undefined ? formatCurrency(card.salePrice) : `<input type="number" class="sale-price-input" data-id="${card.id}" step="0.01" placeholder="Prix" style="width: 80px; text-align: right; padding: 0.25rem; background: #252525; border: 1px solid #3d3d3d; color: #f5f5f5; border-radius: 4px;">`) : '-'}</td><td class="text-right ${cardUnrealizedPnL >= 0 ? 'profit' : 'loss'}">${!card.isSold && card.currentPrice ? formatCurrency(cardUnrealizedPnL) : '-'}</td><td class="text-right ${cardRealizedPnL >= 0 ? 'profit' : 'loss'}">${card.isSold && card.salePrice ? formatCurrency(cardRealizedPnL) : '-'}</td><td><div class="actions"><button class="icon-btn" data-action="editCard" data-id="${card.id}" title="Modifier"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M441 58.9L453.1 71c9.4 9.4 9.4 24.6 0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9 0zM209.8 256.2L344 122l46.1 46.1-134.3 134.2c-2.9 2.9-6.5 5-10.4 6.1L186.9 325l16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25L175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 100c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l100-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7 0-101.8L474.9 25c-28.1-28.1-73.7-28.1-101.8 0zM88 64C39.4 64 0 103.4 0 152V424c0 48.6 39.4 88 88 88H360c48.6 0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1 0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H200c13.3 0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg></button><button class="icon-btn danger" data-action="deleteCard" data-id="${card.id}" title="Supprimer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M170.5 51.6L151.5 80h145l-19-28.4c-1.5-2.2-4-3.6-6.7-3.6H177.1c-2.7 0-5.2 1.3-6.7 3.6zm147-26.6L354.2 80H368h48 8c13.3 0 24 10.7 24 24s-10.7 24-24 24h-8V432c0 44.2-35.8 80-80 80H112c-44.2 0-80-35.8-80-80V128H24c-13.3 0-24-10.7-24-24S10.7 80 24 80h8H80h13.8l36.7-55.1C140.9 9.4 158.4 0 177.1 0h93.7c18.7 0 36.2 9.4 46.6 24.9zM80 128V432c0 17.7 14.3 32 32 32H336c17.7 0 32-14.3 32-32V128H80zm80 64V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16z"/></svg></button></div></td></tr>`;
                    });
                }
            });
            tbody.innerHTML = html;
            attachEventHandlers();
        }

        function updateStats() {
            const totalInvested = cards.reduce((sum, c) => sum + c.purchasePrice, 0);
            const unsoldCards = cards.filter(c => !c.isSold);
            const soldCards = cards.filter(c => c.isSold);
            const currentValue = unsoldCards.reduce((sum, c) => sum + (c.currentPrice || 0), 0);
            const investedInUnsold = unsoldCards.reduce((sum, c) => sum + c.purchasePrice, 0);
            const unrealizedPnL = currentValue - investedInUnsold;
            const unrealizedPnLPercent = investedInUnsold > 0 ? (unrealizedPnL / investedInUnsold) * 100 : 0;
            const realizedPnL = soldCards.reduce((sum, c) => sum + ((c.salePrice || 0) - c.purchasePrice), 0);
            const totalSales = soldCards.reduce((sum, c) => sum + (c.salePrice || 0), 0);

            document.getElementById('totalInvested').textContent = formatCurrency(totalInvested);
            document.getElementById('cardCount').textContent = `${cards.length} carte${cards.length > 1 ? 's' : ''} (${unsoldCards.length} ligne${unsoldCards.length > 1 ? 's' : ''})`;
            document.getElementById('currentValue').textContent = formatCurrency(currentValue);
            const unrealizedEl = document.getElementById('unrealizedPnL');
            unrealizedEl.textContent = formatCurrency(unrealizedPnL);
            unrealizedEl.className = `stat-value ${unrealizedPnL >= 0 ? 'profit' : 'loss'}`;
            const percentEl = document.getElementById('unrealizedPnLPercent');
            percentEl.textContent = `${unrealizedPnL >= 0 ? '+' : ''}${unrealizedPnLPercent.toFixed(2)}%`;
            percentEl.className = `stat-subtext ${unrealizedPnL >= 0 ? 'profit' : 'loss'}`;
            const realizedEl = document.getElementById('realizedPnL');
            realizedEl.textContent = formatCurrency(realizedPnL);
            realizedEl.className = `stat-value ${realizedPnL >= 0 ? 'profit' : 'loss'}`;
            document.getElementById('soldCount').textContent = `${soldCards.length} vendue${soldCards.length > 1 ? 's' : ''}`;
            document.getElementById('totalExpenses').textContent = formatCurrency(totalInvested);
            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
        }

        function renderPerformers() {
            const groups = groupCards(cards.filter(c => !c.isSold && c.currentPrice));
            const performers = groups.map(g => ({
                name: g.name,
                imageUrl: g.imageUrl,
                pnl: g.unrealizedPnL,
                pnlPercent: g.totalInvested > 0 ? (g.unrealizedPnL / g.totalInvested) * 100 : 0
            })).filter(p => p.pnl !== 0);
            performers.sort((a, b) => b.pnlPercent - a.pnlPercent);

            const topPerformers = performers.slice(0, 3);
            const worstPerformers = performers.slice(-3).reverse().filter(p => p.pnlPercent < 0);

            let html = '';
            if (topPerformers.length > 0) {
                html += `<div class="performers-section"><div class="section-header"><span style="color: #10b981; font-size: 1.125rem;">üìà</span><div class="section-title">Meilleurs Performers</div></div>${topPerformers.map(p => `<div class="performer-card"><img src="${p.imageUrl || ''}" alt="${p.name}" class="performer-img"><div class="performer-info"><div class="performer-name">${p.name}</div><div class="performer-stats"><span class="profit"><strong>${formatCurrency(p.pnl)}</strong></span><span class="profit">${p.pnlPercent >= 0 ? '+' : ''}${p.pnlPercent.toFixed(2)}%</span></div></div></div>`).join('')}</div>`;
            }
            if (worstPerformers.length > 0) {
                html += `<div class="performers-section"><div class="section-header"><span style="color: #ef4444; font-size: 1.125rem;">üìâ</span><div class="section-title">Pires Performers</div></div>${worstPerformers.map(p => `<div class="performer-card"><img src="${p.imageUrl || ''}" alt="${p.name}" class="performer-img"><div class="performer-info"><div class="performer-name">${p.name}</div><div class="performer-stats"><span class="loss"><strong>${formatCurrency(p.pnl)}</strong></span><span class="loss">${p.pnlPercent.toFixed(2)}%</span></div></div></div>`).join('')}</div>`;
            }
            if (html === '') html = '<div style="text-align: center; color: #808080; padding: 2rem;">Ajoute des cartes avec prix actuels pour voir les performances</div>';
            document.getElementById('performersContainer').innerHTML = html;
            attachEventHandlers();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(amount);
        }

        // Attach event listeners using delegation (safe for CSP and idempotent)
        let __actionListenerAttached = false;
        function attachEventHandlers() {
            // only attach the global delegated handlers once
            if (!__actionListenerAttached) {
                __actionListenerAttached = true;
                document.body.addEventListener('click', function (e) {
                    const btn = e.target.closest('[data-action]');
                    if (!btn) return;
                    const action = btn.dataset.action;
                    if (action === 'toggleGroup') return toggleGroup(btn.dataset.key);
                    if (action === 'cloneCard') return cloneCard(btn.dataset.id);
                    if (action === 'editCard') return editCard(btn.dataset.id);
                    if (action === 'deleteCard') return deleteCard(btn.dataset.id);
                    if (action === 'updateCurrentPrice') return updateCurrentPrice(btn.dataset.key);
                    if (action === 'openModal') return openModal(); if (action === 'closeModal') return closeModal();
                });

                document.body.addEventListener('change', function (e) {
                    const sel = e.target.closest('[data-role="sold-select"]');
                    if (sel) return toggleSoldStatus(sel.dataset.id, e.target.value);

                    if (e.target.classList.contains('sale-price-input')) {
                        return updateSalePrice(e.target.dataset.id, e.target.value);
                    }
                });
            }

            // Run immediate image sanitization for newly-inserted nodes
            document.querySelectorAll('.card-img').forEach(img => {
                const srcAttr = img.getAttribute('src') || '';
                if (!srcAttr || srcAttr.includes('${') || srcAttr.includes('%7B')) {
                    img.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2248%22 height=%2264%22%3E%3Crect fill=%22%234a3825%22 width=%22100%25%22 height=%22100%25%22/%3E%3C/svg%3E';
                }
                img.onerror = function () { this.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2248%22 height=%2264%22%3E%3Crect fill=%22%234a3825%22 width=%22100%25%22 height=%22100%25%22/%3E%3C/svg%3E'; };
            });
            document.querySelectorAll('.performer-img').forEach(img => {
                const srcAttr = img.getAttribute('src') || '';
                if (!srcAttr || srcAttr.includes('${') || srcAttr.includes('%7B')) {
                    img.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2256%22%3E%3Crect fill=%22%234a3825%22 width=%22100%25%22 height=%22100%25%22/%3E%3C/svg%3E';
                }
                img.onerror = function () { this.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2256%22%3E%3Crect fill=%22%234a3825%22 width=%22100%25%22 height=%22100%25%22/%3E%3C/svg%3E'; };
            });
        }

        // stronger sanitizer: remove stored encoded placeholders too
        function sanitizeCardsArray(arr) {
            let changed = false;
            arr.forEach(c => {
                ['imageUrl', 'cardmarketUrl', 'name'].forEach(k => {
                    if (c[k] && (typeof c[k] === 'string') && (c[k].includes('${') || c[k].includes('%7B') || c[k].trim() === '$')) { c[k] = ''; changed = true; }
                });
            });
            if (changed) {
                // If we sanitized, we should probably save, but let's avoid auto-save loop on load
                // Just update runtime for now, save will happen on next action
            }
        }

        // One-time helper exposed on window for debugging/cleanup
        window.clearPlaceholders = function () {
            sanitizeCardsArray(cards);
            renderCards();
            updateStats();
            updateCharts();
            console.info('clearPlaceholders: sanitized stored cards and refreshed UI');
        };

        function getLastSixMonths() {
            const months = [];
            const monthNames = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({
                    label: monthNames[d.getMonth()],
                    month: d.getMonth(),
                    year: d.getFullYear()
                });
            }
            return months;
        }

        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#b8b8b8' } } },
                scales: {
                    y: { ticks: { color: '#808080' }, grid: { color: '#2d2d2d' } },
                    x: { ticks: { color: '#808080' }, grid: { color: '#2d2d2d' } }
                }
            };

            const lastSixMonths = getLastSixMonths();
            const labels = lastSixMonths.map(m => m.label);

            const portfolioCtx = document.getElementById('portfolioChart').getContext('2d');
            charts.portfolio = new Chart(portfolioCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valeur actuelle',
                        data: [0, 0, 0, 0, 0, 0],
                        borderColor: '#d4af37',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Total investi',
                        data: [0, 0, 0, 0, 0, 0],
                        borderColor: '#6b5542',
                        backgroundColor: 'rgba(107, 85, 66, 0.1)',
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            charts.monthly = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Achats',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: '#6b5542'
                    }, {
                        label: 'Ventes',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: '#d4af37'
                    }]
                },
                options: chartOptions
            });
            updateCharts();
        }

        function updateCharts() {
            const lastSixMonths = getLastSixMonths();

            // Donn√©es pour le graphique mensuel (Achats/Ventes par mois)
            const purchaseData = Array(6).fill(0);
            const saleData = Array(6).fill(0);

            // Donn√©es pour le graphique portfolio (cumul investissement/valeur)
            const investedCumul = Array(6).fill(0);
            const valueCumul = Array(6).fill(0);

            cards.forEach(card => {
                const date = new Date(card.createdAt);
                const cardMonth = date.getMonth();
                const cardYear = date.getFullYear();

                // Trouver l'index du mois correspondant
                const monthIndex = lastSixMonths.findIndex(m => m.month === cardMonth && m.year === cardYear);

                if (monthIndex !== -1) {
                    purchaseData[monthIndex] += card.purchasePrice;
                    if (card.isSold && card.salePrice) {
                        saleData[monthIndex] += card.salePrice;
                    }
                }

                // Pour le cumul, on ajoute √† tous les mois >= date d'achat
                lastSixMonths.forEach((m, idx) => {
                    const monthDate = new Date(m.year, m.month, 1);
                    if (date <= monthDate || (cardMonth === m.month && cardYear === m.year)) {
                        investedCumul[idx] += card.purchasePrice;
                        if (!card.isSold) {
                            valueCumul[idx] += (card.currentPrice || 0);
                        }
                    }
                });
            });

            // Mise √† jour graphique portfolio
            charts.portfolio.data.datasets[0].data = valueCumul;
            charts.portfolio.data.datasets[1].data = investedCumul;
            charts.portfolio.update();

            // Mise √† jour graphique mensuel
            charts.monthly.data.datasets[0].data = purchaseData;
            charts.monthly.data.datasets[1].data = saleData;
            charts.monthly.update();
        }

        // Sanitize DOM from leftover template placeholders (e.g., ${group.imageUrl})
        function sanitizeRenderedDom() {
            try {
                // Fix images with unresolved placeholders
                document.querySelectorAll('[src]').forEach(el => {
                    const v = el.getAttribute('src');
                    if (v && v.includes('${')) {
                        el.setAttribute('src', 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2248%22 height=%2264%22%3E%3Crect fill=%22%234a3825%22 width=%22100%25%22 height=%22100%25%22/%3E%3C/svg%3E');
                    }
                });
                // Remove bad hrefs
                document.querySelectorAll('[href]').forEach(el => {
                    const v = el.getAttribute('href');
                    if (v && v.includes('${')) el.removeAttribute('href');
                });
                // Remove stray template fragments in text nodes
                const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
                let node;
                while (node = walker.nextNode()) {
                    if (node.nodeValue && node.nodeValue.includes('${')) node.nodeValue = node.nodeValue.replace(/\$\{[^}]*\}/g, '');
                }
            } catch (e) {
                console.error('sanitizeRenderedDom error', e);
            }
        }

        document.addEventListener('DOMContentLoaded', sanitizeRenderedDom);
        // Ensure sanitize runs after each render
        const __origRenderCards = renderCards;
        renderCards = function () { __origRenderCards(); sanitizeRenderedDom(); sanitizeCardsArray(cards); };

        document.getElementById('cardModal').addEventListener('click', (e) => {
            if (e.target.id === 'cardModal') closeModal();
        });
    </script>
</body>

</html>